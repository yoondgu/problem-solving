-- 코드를 입력하세요
-- 세단 또는 SUV
-- '2022-11-01'~'2022-11-30' 대여가능
-- 30일간 대여 금액 50만원이상 200만원 미만
-- 자동차 ID, 자동차 종류, 대여 금액(컬럼명: FEE)
-- 금액 내림차순, 자동차 종류 오름차순, ID 내림차순
WITH DISCOUNT_RATE AS (
    SELECT CAR_TYPE, IFNULL(DISCOUNT_RATE, 0) RATE
    FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN
    WHERE DURATION_TYPE = '30일 이상'
    AND CAR_TYPE IN ('세단', 'SUV')
)

SELECT c.CAR_ID, d.CAR_TYPE, FLOOR((c.DAILY_FEE*30)*((100 - d.RATE)/100)) FEE
FROM (
    SELECT DISTINCT c.CAR_ID, c.CAR_TYPE, c.DAILY_FEE
    FROM CAR_RENTAL_COMPANY_CAR c
    WHERE c.CAR_ID NOT IN (
        SELECT DISTINCT CAR_ID
        FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY 
        WHERE (START_DATE >= '2022-11-01' AND END_DATE <= '2022-11-30')
        OR (START_DATE <= '2022-11-01' AND END_DATE >= '2022-11-01')
        OR START_DATE BETWEEN '2022-11-01' AND '2022-11-30'
        OR END_DATE BETWEEN '2022-11-01' AND '2022-11-30'
    )
    AND c.CAR_TYPE IN ('세단', 'SUV')
) c
JOIN DISCOUNT_RATE d
ON c.CAR_TYPE = d.CAR_TYPE
AND FLOOR((c.DAILY_FEE*30)*((100 - d.RATE)/100)) >= 500000
AND FLOOR((c.DAILY_FEE*30)*((100 - d.RATE)/100)) < 2000000
ORDER BY FEE DESC, CAR_TYPE, CAR_ID DESC
;